name: zaqzaq
options:
  bundleIdPrefix: com.zaqzaq-palestinian-dictionary.app
  deploymentTarget:
    iOS: 14.0
fileGroups: [../../src]
configs:
  debug: debug
  release: release
settingGroups:
  app:
    base:
      PRODUCT_NAME: Zaqzaq
      PRODUCT_BUNDLE_IDENTIFIER: com.zaqzaq-palestinian-dictionary.app
targetTemplates:
  app:
    type: application
    sources:
      - path: Sources
    scheme:
      environmentVariables:
        RUST_BACKTRACE: full
        RUST_LOG: info
    settings:
      groups: [app]
targets:
  zaqzaq_iOS:
    type: application
    platform: iOS
    sources:
      - path: Sources
      - path: Assets.xcassets
      - path: zaqzaq_iOS
      - path: assets
        buildPhase: resources
        type: folder
      - path: LaunchScreen.storyboard
    info:
      path: zaqzaq_iOS/Info.plist
      properties:
        LSRequiresIPhoneOS: true
        UILaunchStoryboardName: LaunchScreen
        UIRequiredDeviceCapabilities: [arm64, metal]
        UISupportedInterfaceOrientations:
          - UIInterfaceOrientationPortrait
          - UIInterfaceOrientationLandscapeLeft
          - UIInterfaceOrientationLandscapeRight
        UISupportedInterfaceOrientations~ipad:
          - UIInterfaceOrientationPortrait
          - UIInterfaceOrientationPortraitUpsideDown
          - UIInterfaceOrientationLandscapeLeft
          - UIInterfaceOrientationLandscapeRight
        CFBundleShortVersionString: 0.0.1
        CFBundleVersion: "0.0.1"
    entitlements:
      path: zaqzaq_iOS/zaqzaq_iOS.entitlements
    scheme:
      environmentVariables:
        RUST_BACKTRACE: full
        RUST_LOG: info
    settings:
      base:
        ENABLE_BITCODE: false
        ASSETCATALOG_COMPILER_APPICON_NAME: AppIcon
        ARCHS: [arm64]
        VALID_ARCHS: arm64 
        LIBRARY_SEARCH_PATHS[arch=x86_64]: $(inherited) $(PROJECT_DIR)/Externals/x86_64/$(CONFIGURATION) $(SDKROOT)/usr/lib/swift $(TOOLCHAIN_DIR)/usr/lib/swift/$(PLATFORM_NAME) $(TOOLCHAIN_DIR)/usr/lib/swift-5.0/$(PLATFORM_NAME)
        LIBRARY_SEARCH_PATHS[arch=arm64]: $(inherited) $(PROJECT_DIR)/Externals/arm64/$(CONFIGURATION) $(SDKROOT)/usr/lib/swift $(TOOLCHAIN_DIR)/usr/lib/swift/$(PLATFORM_NAME) $(TOOLCHAIN_DIR)/usr/lib/swift-5.0/$(PLATFORM_NAME)
        ALWAYS_EMBED_SWIFT_STANDARD_LIBRARIES: true
        EXCLUDED_ARCHS[sdk=iphoneos*]: x86_64
      groups: [app]
    dependencies:
      - framework: libapp.a
        embed: false
      - sdk: CoreGraphics.framework
      - sdk: Metal.framework
      - sdk: MetalKit.framework
      - sdk: QuartzCore.framework
      - sdk: Security.framework
      - sdk: UIKit.framework
      - sdk: WebKit.framework
    preBuildScripts:
      - script: |
          set -e
      - script: |
          set -e
          set -x
          echo "Build Script Started"
          echo "User: $(whoami)"
          echo "Original PATH: $PATH"
          echo "Workspace Root: $SRCROOT"
          
          # Check if ci_scripts exists
          if [ -d "$SRCROOT/../../ci_scripts" ]; then
            echo "ci_scripts directory found."
            ls -l "$SRCROOT/../../ci_scripts"
          else
            echo "WARNING: ci_scripts directory NOT found. Are you on the 'fix/ios-icon' branch?"
          fi

          # Sourcing cargo env
          if [ -f "$HOME/.cargo/env" ]; then 
            source "$HOME/.cargo/env"
          fi

          # Attempt to find Homebrew
          if [ -x "/opt/homebrew/bin/brew" ]; then
            eval "$(/opt/homebrew/bin/brew shellenv)"
          elif [ -x "/usr/local/bin/brew" ]; then
            eval "$(/usr/local/bin/brew shellenv)"
          elif [ -x "$HOME/Homebrew/bin/brew" ]; then
            eval "$($HOME/Homebrew/bin/brew shellenv)"
          else
             echo "Brew not found in standard locations."
          fi

          # Check installed packages
          if command -v brew >/dev/null 2>&1; then
             echo "Brew found at $(which brew)"
             echo "Installed formulae:"
             brew list --formula || echo "Failed to list brew formulae"
             
             # Try to find node prefix
             if brew list node >/dev/null 2>&1; then
               NODE_PREFIX=$(brew --prefix node)
               export PATH="$NODE_PREFIX/bin:$PATH"
               echo "Added Node binary path: $NODE_PREFIX/bin"
             fi
          fi

          echo "Final PATH: $PATH"

          # Debug binary locations again
          which node || echo "node still not found"
          which npm || echo "npm still not found"
          which cargo || echo "cargo still not found"
          
          # Run the actual command
          npm run -- tauri ios xcode-script -v --platform ${PLATFORM_DISPLAY_NAME:?} --sdk-root ${SDKROOT:?} --framework-search-paths "${FRAMEWORK_SEARCH_PATHS:?}" --header-search-paths "${HEADER_SEARCH_PATHS:?}" --gcc-preprocessor-definitions "${GCC_PREPROCESSOR_DEFINITIONS:-}" --configuration ${CONFIGURATION:?} ${FORCE_COLOR} ${ARCHS:?}
        name: Build Rust Code
        basedOnDependencyAnalysis: false
        outputFiles:
          - $(SRCROOT)/Externals/x86_64/${CONFIGURATION}/libapp.a
          - $(SRCROOT)/Externals/arm64/${CONFIGURATION}/libapp.a